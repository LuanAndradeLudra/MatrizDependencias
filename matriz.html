<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Consulta de Entidades Ligadas</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #eef2f5;
            margin: 0;
            padding: 0
        }

        .container {
            display: grid;
            grid-template-columns: 360px 1fr 1fr;
            /* agora 20% mais largo */
            gap: 1rem;
            height: calc(100vh - 2rem);
            padding: 1rem;
            box-sizing: border-box;
        }

        .box,
        .results,
        .graph {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
            padding: 1rem;
            overflow: auto;
            box-sizing: border-box;
        }

        h2 {
            margin-top: 0;
            font-size: 1.2rem;
            text-align: center;
            color: #333
        }

        #apiSection {
            display: flex;
            gap: .5rem;
            margin-bottom: 1rem;
            align-items: center;
        }

        #apiKeyInput {
            flex: 1;
            padding: .5rem;
            font-size: 1rem;
            border: 1px solid #ccc;
            border-radius: 4px;
            background: #f8d7da;
            color: #721c24;
        }

        #apiOkBtn {
            padding: .5rem 1rem;
            font-size: 1rem;
            background: #c82333;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        #apiOkBtn:hover {
            background: #a71d2a
        }

        #entitySection {
            display: none;
            margin-bottom: 1rem
        }

        .search-inline {
            display: flex;
            gap: .5rem;
        }

        #entityInput {
            flex: 1;
            padding: .5rem;
            font-size: 1rem;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        #searchBtn {
            padding: .5rem 1rem;
            font-size: 1rem;
            background: #2a5298;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        #searchBtn:hover {
            background: #1e3c72
        }

        #listPanel {
            max-height: calc(100% - 8rem);
            overflow-y: auto;
            border-top: 1px solid #ddd;
            padding-top: .5rem;
        }

        .entity-item {
            padding: .3rem .5rem;
            cursor: pointer;
            border-radius: 3px;
        }

        .entity-item:hover {
            background: #f0f0f0
        }

        #result {
            line-height: 1.5
        }

        #result ul {
            padding-left: 1.2rem
        }

        .clickable {
            cursor: pointer;
            color: #2a5298;
            text-decoration: underline;
        }

        .no-results {
            color: #c0392b
        }

        .graph svg {
            width: 100%;
            height: 100%
        }

        .graph svg circle,
        .graph svg text {
            cursor: pointer
        }
    </style>
</head>

<body>

    <div class="container">

        <!-- ESQUERDA: API Key + Lista -->
        <div class="box">
            <h2>Configuração</h2>
            <div id="apiSection">
                <input id="apiKeyInput" type="text" placeholder="Cole sua API Key aqui" />
                <button id="apiOkBtn">OK</button>
            </div>

            <div id="entitySection">
                <div class="search-inline">
                    <input id="entityInput" type="text" placeholder="Digite ou clique" />
                    <button id="searchBtn">Buscar</button>
                </div>
            </div>

            <div id="listPanel">
                <p class="no-results">Insira sua API Key e clique em OK.</p>
            </div>
        </div>

        <!-- MEIO: Resultados -->
        <div class="results">
            <h2>Entidades Ligadas</h2>
            <div id="result">
                <p class="no-results">Aguardando pesquisa…</p>
            </div>
        </div>

        <!-- DIREITA: Gráfico -->
        <div class="graph" id="graph"></div>

    </div>

    <script>
        const SHEET_ID = '16xGc25id9YdFgzDEF5Mgxe1OycDC8WaVQS06u5Juz6s';
        const HEADER_ROW = 2, START_ROW = 5;
        let data = [];

        function getApiKey() {
            return document.getElementById('apiKeyInput').value.trim();
        }

        async function loadSheet() {
            const key = getApiKey();
            if (!key) throw new Error('API Key não fornecida.');
            const range = `A${HEADER_ROW}:Z`;
            const url = `https://sheets.googleapis.com/v4/spreadsheets/`
                + `${SHEET_ID}/values/${encodeURIComponent(range)}?key=${key}`;
            const res = await fetch(url);
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            const rows = (await res.json()).values;
            const header = rows[0].slice(1);
            const offset = START_ROW - HEADER_ROW;
            data = rows.slice(offset).map(r => {
                const o = { Entity: r[0] || '' };
                header.forEach((h, i) => o[h] = r[i + 1] || '');
                return o;
            });
            if (!data.length) throw new Error('Nenhuma entidade encontrada.');
            document.getElementById('listPanel').innerHTML =
                data.map(o =>
                    `<div class="entity-item"`
                    + ` onclick="buscar('${o.Entity.replace(/'/g, "\\'")}')">`
                    + `${o.Entity}</div>`
                ).join('');
        }

        async function onApiOk() {
            try {
                await loadSheet();
                const inp = document.getElementById('apiKeyInput');
                inp.style.background = '#d4edda';
                inp.style.color = '#155724';
                document.getElementById('entitySection').style.display = 'block';
            } catch (e) {
                document.getElementById('listPanel').innerHTML =
                    `<p class="no-results">${e.message}</p>`;
            }
        }

        document.getElementById('apiOkBtn')
            .addEventListener('click', onApiOk);

        document.getElementById('searchBtn')
            .addEventListener('click', () => buscar());

        document.getElementById('entityInput')
            .addEventListener('keydown', e => {
                if (e.key === 'Enter') buscar();
            });

        function buscar(name) {
            const ent = (name || document.getElementById('entityInput').value).trim();
            const resDiv = document.getElementById('result');
            resDiv.innerHTML = '';
            if (!ent) {
                resDiv.innerHTML = '<p class="no-results">Digite uma entidade.</p>';
                clearGraph();
                return;
            }
            document.getElementById('entityInput').value = ent;

            const row = data.find(r => r.Entity.toLowerCase() === ent.toLowerCase());
            if (!row) {
                resDiv.innerHTML =
                    `<p class="no-results">Entidade "<strong>${ent}</strong>" não encontrada.</p>`;
                clearGraph();
                return;
            }

            const keys = Object.keys(row)
                .filter(k => k !== 'Entity' && String(row[k]).trim());
            if (!keys.length) {
                resDiv.innerHTML =
                    `<p class="no-results">Nenhuma dependência para "<strong>${ent}</strong>".</p>`;
                clearGraph();
                return;
            }

            resDiv.innerHTML = `
        <ul>
          ${keys.map(k => {
                const v = row[k],
                    lab = String(v).toUpperCase() === 'X' ? k : `${k} (${v})`;
                return `<li class="clickable"`
                    + ` onclick="buscar('${k.replace(/'/g, "\\'")}')">${lab}</li>`;
            }).join('')}
        </ul>`;
            drawGraph(ent, keys);
        }

        function clearGraph() {
            document.getElementById('graph').innerHTML = '';
        }

        function drawGraph(center, nodes) {
            const DIV = document.getElementById('graph');
            DIV.innerHTML = '';
            const W = DIV.clientWidth, H = DIV.clientHeight || 500,
                cx = W / 2, cy = H / 2, R = Math.min(W, H) / 3,
                r0 = 60, r1 = 40;
            const NS = 'http://www.w3.org/2000/svg',
                svg = document.createElementNS(NS, 'svg');
            svg.setAttribute('width', W);
            svg.setAttribute('height', H);
            DIV.appendChild(svg);

            nodes.forEach((k, i) => {
                const ang = 2 * Math.PI * i / nodes.length;
                const x = cx + R * Math.cos(ang), y = cy + R * Math.sin(ang);
                const ln = document.createElementNS(NS, 'line');
                ln.setAttribute('x1', cx); ln.setAttribute('y1', cy);
                ln.setAttribute('x2', x); ln.setAttribute('y2', y);
                ln.setAttribute('stroke', '#888');
                svg.appendChild(ln);
            });

            function makeMultiText(text, x, y, sz, fill, fn) {
                const g = document.createElementNS(NS, 'text');
                g.setAttribute('x', x); g.setAttribute('y', y);
                g.setAttribute('text-anchor', 'middle');
                g.setAttribute('fill', fill);
                g.setAttribute('font-size', sz + 'px');
                g.style.cursor = 'pointer';
                g.addEventListener('click', fn);
                const parts = text.split('>');
                parts.forEach((p, idx) => {
                    let ln = p.trim();
                    if (idx < parts.length - 1) ln += ' >';
                    const tspan = document.createElementNS(NS, 'tspan');
                    tspan.textContent = ln;
                    tspan.setAttribute('x', x);
                    tspan.setAttribute('dy', idx === 0 ? 0 : sz * 1.2);
                    g.appendChild(tspan);
                });
                svg.appendChild(g);
            }

            const c0 = document.createElementNS(NS, 'circle');
            c0.setAttribute('cx', cx); c0.setAttribute('cy', cy); c0.setAttribute('r', r0);
            c0.setAttribute('fill', '#2a5298');
            c0.addEventListener('click', () => buscar(center));
            svg.appendChild(c0);
            makeMultiText(center, cx, cy + 5, 14, '#fff', () => buscar(center));

            nodes.forEach((k, i) => {
                const ang = 2 * Math.PI * i / nodes.length;
                const x = cx + R * Math.cos(ang), y = cy + R * Math.sin(ang);

                const c1 = document.createElementNS(NS, 'circle');
                c1.setAttribute('cx', x); c1.setAttribute('cy', y); c1.setAttribute('r', r1);
                c1.setAttribute('fill', '#fff');
                c1.setAttribute('stroke', '#2a5298');
                c1.addEventListener('click', () => buscar(k));
                svg.appendChild(c1);

                makeMultiText(k, x, y + 5, 12, '#2a5298', () => buscar(k));
            });
        }
    </script>
</body>

</html>